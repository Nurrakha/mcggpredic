<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Prediksi Lawan Pertandingan (Sampai Fase 5)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Dark theme */
        --bg: #050814; /* hitam kebiruan */
        --bg2: #070b1f;
        --card: #0b1026; /* panel */
        --card2: #0a0f22;
        --text: #eaf0ff; /* teks utama */
        --muted: #9aa7c2; /* teks kecil */
        --border: rgba(148, 163, 184, 0.18);

        /* Blue accents */
        --blue-300: #7dd3fc;
        --blue-400: #60a5fa;
        --blue-500: #3b82f6;
        --blue-600: #2563eb;
        --blue-700: #1d4ed8;

        --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        --shadow-sm: 0 10px 24px rgba(0, 0, 0, 0.35);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px;
        color: var(--text);
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        line-height: 1.45;
        background:
          radial-gradient(
            1000px 520px at 12% -10%,
            rgba(59, 130, 246, 0.28),
            transparent 60%
          ),
          radial-gradient(
            900px 420px at 92% 0%,
            rgba(29, 78, 216, 0.22),
            transparent 55%
          ),
          radial-gradient(
            900px 420px at 40% 120%,
            rgba(125, 211, 252, 0.12),
            transparent 60%
          ),
          linear-gradient(180deg, var(--bg), var(--bg2));
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
      }

      h1 {
        margin: 0 0 10px;
        font-size: clamp(22px, 2.2vw, 30px);
        letter-spacing: -0.02em;
      }
      h2 {
        margin: 0 0 10px;
        font-size: 18px;
        letter-spacing: -0.01em;
      }

      .note {
        color: var(--muted);
        font-size: 14px;
      }
      .ok {
        color: #34d399;
        font-weight: 800;
      }
      .warn {
        color: #fbbf24;
        font-weight: 800;
      }

      /* Cards */
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        margin: 14px 0;
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(6px);
      }

      /* Section header dot */
      .card > h2 {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .card > h2::before {
        content: "";
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--blue-500);
        box-shadow:
          0 0 0 4px rgba(59, 130, 246, 0.2),
          0 0 22px rgba(59, 130, 246, 0.35);
        display: inline-block;
      }

      /* Grid */
      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 900px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      /* Forms */
      label {
        font-weight: 800;
        font-size: 13px;
        color: #cfe0ff;
        display: block;
        margin-bottom: 6px;
      }

      input[type="text"],
      select {
        width: 100%;
        padding: 11px 12px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.22);
        background: rgba(2, 6, 23, 0.55);
        color: var(--text);
        outline: none;
        transition:
          box-shadow 0.2s ease,
          border-color 0.2s ease,
          transform 0.05s ease;
      }
      select[multiple] {
        min-height: 170px;
        padding: 10px;
      }

      input[type="text"]::placeholder {
        color: rgba(234, 240, 255, 0.55);
      }

      input[type="text"]:focus,
      select:focus {
        border-color: rgba(59, 130, 246, 0.75);
        box-shadow:
          0 0 0 4px rgba(59, 130, 246, 0.2),
          0 0 20px rgba(59, 130, 246, 0.18);
      }
      input[type="text"]:active,
      select:active {
        transform: translateY(0.5px);
      }

      select option {
        background: #0b1026;
        color: var(--text);
      }
      select option:disabled {
        color: rgba(154, 167, 194, 0.6);
      }

      /* Buttons */
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      button {
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid rgba(96, 165, 250, 0.35);
        background: linear-gradient(
          180deg,
          rgba(37, 99, 235, 1),
          rgba(29, 78, 216, 1)
        );
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 12px 22px rgba(37, 99, 235, 0.2);
        transition:
          transform 0.15s ease,
          box-shadow 0.15s ease,
          filter 0.15s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 28px rgba(37, 99, 235, 0.25);
        filter: brightness(1.03);
      }
      button:active {
        transform: translateY(0px);
        box-shadow: 0 10px 18px rgba(37, 99, 235, 0.18);
      }

      button.secondary {
        background: rgba(255, 255, 255, 0.06);
        color: #cfe0ff;
        border: 1px solid rgba(148, 163, 184, 0.22);
        box-shadow: none;
      }
      button.secondary:hover {
        background: rgba(255, 255, 255, 0.09);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.25);
      }

      /* Pills */
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.22);
        color: #cfe0ff;
        margin: 6px 8px 0 0;
        font-weight: 800;
        font-size: 12.5px;
      }
      .pill button {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(96, 165, 250, 0.35);
        background: rgba(2, 6, 23, 0.35);
        color: #cfe0ff;
        box-shadow: none;
        font-size: 12px;
      }
      .pill button:hover {
        background: rgba(59, 130, 246, 0.12);
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 12px;
        overflow: hidden;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: rgba(2, 6, 23, 0.25);
      }
      thead th {
        background: linear-gradient(
          180deg,
          rgba(59, 130, 246, 0.16),
          rgba(59, 130, 246, 0.08)
        );
        color: #d7e6ff;
        font-weight: 900;
        font-size: 13px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        padding: 12px;
      }
      tbody td {
        padding: 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.14);
        color: var(--text);
        font-size: 14px;
        vertical-align: top;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      tbody tr:hover td {
        background: rgba(59, 130, 246, 0.08);
      }

      .hidden {
        display: none;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        font-size: 13px;
        color: #d7e6ff;
        background: rgba(59, 130, 246, 0.1);
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(59, 130, 246, 0.18);
      }

      /* Nice scrollbar (optional) */
      ::-webkit-scrollbar {
        height: 10px;
        width: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.25);
        border-radius: 999px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(148, 163, 184, 0.35);
      }
    </style>
  </head>
  <body>
    <h1>Prediksi Lawan Pertandingan (Sampai Fase 5)</h1>
    <p class="note">
      Kunci input: pilih lawan di <b>F1 (M1–M3)</b> & <b>F2 (M1–M4)</b>.
      <b
        >Musuh yang sudah dipilih di satu match tidak bisa dipilih di match
        lain.</b
      >
      Tambah musuh yang gugur di <b>Daftar Tereliminasi</b> (bisa banyak). Klik
      <b>Prediksi</b> untuk tabel otomatis sampai <b>Fase 5 Match 5</b>.
    </p>

    <div class="card">
      <h2>Daftar Player</h2>
      <div class="grid" id="playersGrid"></div>
      <div class="row" style="margin-top: 12px">
        <button id="btnSavePlayers">Save</button>
        <button class="secondary" id="btnLoadPlayers">Load</button>
        <button class="secondary" id="btnClearPlayers">Clear Saved</button>
        <span id="saveStatus" class="note"></span>
      </div>
    </div>

    <div class="card">
      <h2>Fase 1 (3 Match)</h2>
      <div class="grid">
        <div>
          <label for="f1m1">Match 1 - Lawan</label
          ><select id="f1m1"></select>
        </div>
        <div>
          <label for="f1m2">Match 2 - Lawan</label
          ><select id="f1m2"></select>
        </div>
        <div>
          <label for="f1m3">Match 3 - Lawan</label
          ><select id="f1m3"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Fase 2 (Input hanya sampai Match 4)</h2>
      <div class="grid">
        <div>
          <label for="f2m1">Match 1 - Lawan</label
          ><select id="f2m1"></select>
        </div>
        <div>
          <label for="f2m2">Match 2 - Lawan</label
          ><select id="f2m2"></select>
        </div>
        <div>
          <label for="f2m3">Match 3 - Lawan</label
          ><select id="f2m3"></select>
        </div>
        <div>
          <label for="f2m4">Match 4 - Lawan</label
          ><select id="f2m4"></select>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Daftar Tereliminasi (Bisa Banyak)</h2>
      <div class="grid">
        <div>
          <label for="elimPickMulti"
            >Pilih nama yang tereliminasi (boleh banyak)</label
          >
          <select id="elimPickMulti" multiple></select>
          <div class="note" style="margin-top: 6px">
            Tips: tahan <b>Ctrl</b> (Windows) / <b>Cmd</b> (Mac) untuk pilih
            banyak.
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="row">
            <button id="btnAddElim">Tambah yang Dipilih</button>
            <button class="secondary" id="btnClearElim">Clear Eliminasi</button>
          </div>

          <div style="margin-top: 12px">
            <div class="note">Tereliminasi saat ini:</div>
            <div id="elimList"></div>
            <div class="note" style="margin-top: 8px">
              Aturan: jika lawan di tabel prediksi <b>tereliminasi</b>,
              tampilkan <b>kemungkinan lawan</b> = match sesudahnya
              <b>atau</b> sesudahnya lagi (yang tidak tereliminasi).
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Kontrol</h2>
      <div class="row">
        <button id="btnPredict">Prediksi Match Berikutnya</button>
        <button class="secondary" id="btnResetMatches">
          Reset Pilihan Match
        </button>
      </div>

      <div style="margin-top: 12px" id="validationMsg" class="note"></div>

      <div style="margin-top: 14px">
        <div class="note">
          Ringkasan lawan yang sudah kamu pilih (F1 M1–M3, F2 M1–M4):
        </div>
        <div id="pickedList"></div>
      </div>
    </div>

    <div class="card hidden" id="predictedCard">
      <h2>Tabel Musuh di Fase Berikutnya (Otomatis) — Sampai Fase 5</h2>
      <div class="note">
        Pola loop kunci:
        <span class="mono"
          >F1M1 → F1M2 → F1M3 → F2M1 → F2M2 → F2M3 → F2M4 → ulang</span
        >
      </div>

      <table>
        <thead>
          <tr>
            <th>Fase</th>
            <th>Match</th>
            <th>Lawan (Auto / Kemungkinan jika tereliminasi)</th>
            <th>Sumber</th>
          </tr>
        </thead>
        <tbody id="predictedTableBody"></tbody>
      </table>
    </div>

    <script>
      const STORAGE_KEY_PLAYERS = "prediksi_lawan_players_v6";
      const STORAGE_KEY_ELIM = "prediksi_lawan_elim_v3";

      const defaultPlayers = [
        { id: 1, label: "Player 1 (Kamu)", defaultName: "Saya" },
        { id: 2, label: "Musuh 1", defaultName: "Musuh 1" },
        { id: 3, label: "Musuh 2", defaultName: "Musuh 2" },
        { id: 4, label: "Musuh 3", defaultName: "Musuh 3" },
        { id: 5, label: "Musuh 4", defaultName: "Musuh 4" },
        { id: 6, label: "Musuh 5", defaultName: "Musuh 5" },
        { id: 7, label: "Musuh 6", defaultName: "Musuh 6" },
        { id: 8, label: "Musuh 7", defaultName: "Musuh 7" },
      ];

      const playersGrid = document.getElementById("playersGrid");
      const saveStatus = document.getElementById("saveStatus");
      const validationMsg = document.getElementById("validationMsg");
      const elimPickMulti = document.getElementById("elimPickMulti");
      const elimList = document.getElementById("elimList");

      // manual match selects
      const matchSelectIds = [
        "f1m1",
        "f1m2",
        "f1m3",
        "f2m1",
        "f2m2",
        "f2m3",
        "f2m4",
      ];

      let eliminated = new Set(loadEliminated());

      function makePlayerInputs(players) {
        playersGrid.innerHTML = "";
        players.forEach((p) => {
          const wrap = document.createElement("div");
          const label = document.createElement("label");
          label.textContent = p.label;

          const input = document.createElement("input");
          input.type = "text";
          input.id = `player${p.id}`;
          input.value = p.defaultName || "";

          wrap.appendChild(label);
          wrap.appendChild(input);
          playersGrid.appendChild(wrap);
        });
      }

      function readPlayersFromUI() {
        const names = [];
        for (let i = 1; i <= 8; i++)
          names.push(
            (document.getElementById(`player${i}`).value || "").trim(),
          );
        return names;
      }

      function getEnemyNamesFromUI() {
        return readPlayersFromUI()
          .slice(1)
          .map((x) => x.trim())
          .filter(Boolean);
      }

      function escapeHtml(str) {
        return str.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            })[m],
        );
      }

      // ===== Save / Load players =====
      function savePlayers() {
        const names = readPlayersFromUI();
        const enemies = names.slice(1).filter((n) => n.trim() !== "");
        if (enemies.length < 7) {
          saveStatus.innerHTML = `<span class="warn">Isi semua musuh dulu (7 nama musuh).</span>`;
          return;
        }
        localStorage.setItem(STORAGE_KEY_PLAYERS, JSON.stringify(names));
        saveStatus.innerHTML = `<span class="ok">Tersimpan. Dropdown diperbarui.</span>`;
        buildAllMatchSelectOptions(true);
        buildElimMultiOptions();
        renderPickedList();
        renderElimPills();
        hidePredicted();
      }

      function loadPlayers() {
        const raw = localStorage.getItem(STORAGE_KEY_PLAYERS);
        if (!raw) {
          saveStatus.textContent = "Belum ada data tersimpan.";
          return;
        }
        const names = JSON.parse(raw);
        for (let i = 1; i <= 8; i++)
          document.getElementById(`player${i}`).value = (
            names[i - 1] ?? ""
          ).toString();
        saveStatus.innerHTML = `<span class="ok">Data player di-load.</span>`;
        buildAllMatchSelectOptions(false);
        buildElimMultiOptions();
        renderPickedList();
        renderElimPills();
        hidePredicted();
      }

      function clearSavedPlayers() {
        localStorage.removeItem(STORAGE_KEY_PLAYERS);
        saveStatus.textContent = "Data tersimpan dihapus.";
      }

      // ===== Anti double-pick =====
      function getPickedValues() {
        const picked = {};
        matchSelectIds.forEach(
          (id) =>
            (picked[id] = (document.getElementById(id).value || "").trim()),
        );
        return picked;
      }

      function getUsedNamesExcluding(currentSelectId) {
        const used = new Set();
        matchSelectIds.forEach((id) => {
          if (id === currentSelectId) return;
          const v = (document.getElementById(id).value || "").trim();
          if (v) used.add(v);
        });
        return used;
      }

      function buildSelectOptionsForMatch(selectId, enemyNames, keepValue) {
        const sel = document.getElementById(selectId);
        const current = keepValue ? (sel.value || "").trim() : "";

        sel.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "-- pilih lawan --";
        sel.appendChild(opt0);

        const usedByOthers = getUsedNamesExcluding(selectId);

        enemyNames.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;

          // disable jika sudah dipakai di select lain, kecuali pilihan current
          const shouldDisable = usedByOthers.has(name) && name !== current;
          opt.disabled = shouldDisable;

          sel.appendChild(opt);
        });

        if (keepValue && current && enemyNames.includes(current))
          sel.value = current;
        else sel.value = "";
      }

      function buildAllMatchSelectOptions(keepValues) {
        const enemies = getEnemyNamesFromUI();
        matchSelectIds.forEach((id) =>
          buildSelectOptionsForMatch(id, enemies, keepValues),
        );
        refreshAllMatchDisables();
      }

      function refreshAllMatchDisables() {
        const enemies = getEnemyNamesFromUI();
        matchSelectIds.forEach((id) =>
          buildSelectOptionsForMatch(id, enemies, true),
        );
      }

      // ===== Eliminasi multi =====
      function loadEliminated() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY_ELIM);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr.map(String) : [];
        } catch {
          return [];
        }
      }

      function saveEliminated() {
        localStorage.setItem(STORAGE_KEY_ELIM, JSON.stringify([...eliminated]));
      }

      function buildElimMultiOptions() {
        const enemies = getEnemyNamesFromUI();
        elimPickMulti.innerHTML = "";
        enemies.forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = eliminated.has(name)
            ? `${name} (sudah tereliminasi)`
            : name;
          opt.disabled = eliminated.has(name);
          elimPickMulti.appendChild(opt);
        });
      }

      function addEliminatedMulti() {
        const selected = [...elimPickMulti.selectedOptions]
          .map((o) => (o.value || "").trim())
          .filter(Boolean);
        if (!selected.length) return;

        selected.forEach((n) => eliminated.add(n));
        saveEliminated();
        buildElimMultiOptions();
        renderElimPills();
        hidePredicted();
      }

      function clearEliminated() {
        eliminated = new Set();
        saveEliminated();
        buildElimMultiOptions();
        renderElimPills();
        hidePredicted();
      }

      function renderElimPills() {
        const arr = [...eliminated];
        if (!arr.length) {
          elimList.innerHTML = `<span class="note">Belum ada.</span>`;
          return;
        }
        elimList.innerHTML = arr
          .map(
            (name) => `
      <span class="pill">
        ${escapeHtml(name)}
        <button data-remove="${escapeHtml(name)}" title="Hapus">x</button>
      </span>
    `,
          )
          .join("");

        [...elimList.querySelectorAll("button[data-remove]")].forEach((btn) => {
          btn.addEventListener("click", () => {
            const n = btn.getAttribute("data-remove");
            eliminated.delete(n);
            saveEliminated();
            buildElimMultiOptions();
            renderElimPills();
            hidePredicted();
          });
        });
      }

      // ===== UI: picked list =====
      function renderPickedList() {
        const picked = getPickedValues();
        const items = [];
        const mapLabel = {
          f1m1: "F1 Match 1",
          f1m2: "F1 Match 2",
          f1m3: "F1 Match 3",
          f2m1: "F2 Match 1",
          f2m2: "F2 Match 2",
          f2m3: "F2 Match 3",
          f2m4: "F2 Match 4",
        };
        for (const id of matchSelectIds) {
          const v = picked[id];
          if (v) items.push(`${mapLabel[id]}: ${escapeHtml(v)}`);
        }
        document.getElementById("pickedList").innerHTML = items.length
          ? items.map((t) => `<span class="pill">${t}</span>`).join("")
          : `<span class="note">Belum ada pilihan.</span>`;
      }

      function hidePredicted() {
        document.getElementById("predictedCard").classList.add("hidden");
        document.getElementById("predictedTableBody").innerHTML = "";
        validationMsg.textContent = "";
      }

      function validateAllFilled() {
        const picked = getPickedValues();
        const missing = [];
        for (const id of matchSelectIds) if (!picked[id]) missing.push(id);
        return missing;
      }

      // ===== Prediksi (raw rows sampai fase 5 match 5) =====
      function buildPredictedRowsRaw() {
        const v = getPickedValues();
        return [
          // Fase 2
          {
            phase: "Fase 2",
            match: "Match 5",
            opponent: v.f1m1,
            source: "Fase 1 Match 1",
          },

          // Fase 3
          {
            phase: "Fase 3",
            match: "Match 1",
            opponent: v.f1m2,
            source: "Fase 1 Match 2",
          },
          {
            phase: "Fase 3",
            match: "Match 2",
            opponent: v.f1m3,
            source: "Fase 1 Match 3",
          },
          {
            phase: "Fase 3",
            match: "Match 3",
            opponent: v.f2m1,
            source: "Fase 2 Match 1",
          },
          {
            phase: "Fase 3",
            match: "Match 4",
            opponent: v.f2m2,
            source: "Fase 2 Match 2",
          },
          {
            phase: "Fase 3",
            match: "Match 5",
            opponent: v.f2m3,
            source: "Fase 2 Match 3",
          },

          // Fase 4
          {
            phase: "Fase 4",
            match: "Match 1",
            opponent: v.f2m4,
            source: "Fase 2 Match 4",
          },
          {
            phase: "Fase 4",
            match: "Match 2",
            opponent: v.f1m1,
            source: "Fase 1 Match 1",
          },
          {
            phase: "Fase 4",
            match: "Match 3",
            opponent: v.f1m2,
            source: "Fase 1 Match 2",
          },
          {
            phase: "Fase 4",
            match: "Match 4",
            opponent: v.f1m3,
            source: "Fase 1 Match 3",
          },
          {
            phase: "Fase 4",
            match: "Match 5",
            opponent: v.f2m1,
            source: "Fase 2 Match 1",
          },

          // Fase 5 (lanjutan loop)
          {
            phase: "Fase 5",
            match: "Match 1",
            opponent: v.f2m2,
            source: "Fase 2 Match 2",
          },
          {
            phase: "Fase 5",
            match: "Match 2",
            opponent: v.f2m3,
            source: "Fase 2 Match 3",
          },
          {
            phase: "Fase 5",
            match: "Match 3",
            opponent: v.f2m4,
            source: "Fase 2 Match 4",
          },
          {
            phase: "Fase 5",
            match: "Match 4",
            opponent: v.f1m1,
            source: "Fase 1 Match 1",
          },
          {
            phase: "Fase 5",
            match: "Match 5",
            opponent: v.f1m2,
            source: "Fase 1 Match 2",
          },
        ];
      }

      // Jika lawan tereliminasi: tampilkan kemungkinan = next atau next-next (yang tidak tereliminasi)
      function resolveOpponentDisplay(rows, idx) {
        const current = (rows[idx].opponent || "").trim();
        if (!current) return { text: "(belum ada)", note: "" };

        if (!eliminated.has(current)) return { text: current, note: "" };

        const candidates = [];
        for (let j = idx + 1; j < rows.length && candidates.length < 2; j++) {
          const cand = (rows[j].opponent || "").trim();
          if (!cand) continue;
          if (eliminated.has(cand)) continue;
          candidates.push({
            phase: rows[j].phase,
            match: rows[j].match,
            name: cand,
          });
        }

        if (candidates.length === 0) {
          return {
            text: `(${current} tereliminasi; tidak ada kandidat selanjutnya)`,
            note: "",
          };
        }

        const parts = candidates.map((c) => `${c.phase} ${c.match}: ${c.name}`);
        return {
          text: `Kemungkinan: ${parts.join(" atau ")}`,
          note: `(${current} tereliminasi)`,
        };
      }

      function renderPredictedTable() {
        const missing = validateAllFilled();
        if (missing.length) {
          document.getElementById("predictedCard").classList.add("hidden");
          validationMsg.innerHTML = `<span class="warn">Lengkapi dulu semua pilihan: F1 (M1–M3) & F2 (M1–M4).</span>`;
          return;
        }

        validationMsg.innerHTML = `<span class="ok">Tabel prediksi sudah memperhitungkan eliminasi.</span>`;

        const rows = buildPredictedRowsRaw();
        const tbody = document.getElementById("predictedTableBody");

        tbody.innerHTML = rows
          .map((r, i) => {
            const resolved = resolveOpponentDisplay(rows, i);
            const extra = resolved.note
              ? `<div class="note">${escapeHtml(resolved.note)}</div>`
              : "";
            return `
        <tr>
          <td>${escapeHtml(r.phase)}</td>
          <td>${escapeHtml(r.match)}</td>
          <td>${escapeHtml(resolved.text)}${extra}</td>
          <td>${escapeHtml(r.source)}</td>
        </tr>
      `;
          })
          .join("");

        document.getElementById("predictedCard").classList.remove("hidden");
      }

      function resetMatches() {
        matchSelectIds.forEach(
          (id) => (document.getElementById(id).value = ""),
        );
        renderPickedList();
        refreshAllMatchDisables();
        hidePredicted();
      }

      // ===== Init =====
      makePlayerInputs(defaultPlayers);
      buildAllMatchSelectOptions(false);
      buildElimMultiOptions();
      renderPickedList();
      renderElimPills();
      hidePredicted();

      // ===== Events =====
      document
        .getElementById("btnSavePlayers")
        .addEventListener("click", savePlayers);
      document
        .getElementById("btnLoadPlayers")
        .addEventListener("click", loadPlayers);
      document
        .getElementById("btnClearPlayers")
        .addEventListener("click", clearSavedPlayers);

      document
        .getElementById("btnAddElim")
        .addEventListener("click", addEliminatedMulti);
      document
        .getElementById("btnClearElim")
        .addEventListener("click", clearEliminated);

      document.getElementById("btnPredict").addEventListener("click", () => {
        renderPickedList();
        renderPredictedTable();
      });

      document
        .getElementById("btnResetMatches")
        .addEventListener("click", resetMatches);

      // setiap kali pilih match, anti double-pick refresh
      matchSelectIds.forEach((id) => {
        document.getElementById(id).addEventListener("change", () => {
          renderPickedList();
          refreshAllMatchDisables();
          hidePredicted();
        });
      });
    </script>
  </body>
</html>